cmake_minimum_required(VERSION 3.10.2 FATAL_ERROR)
project(IlluminationEngine)

set(ILLUMINATION_ENGINE_BASE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})
set(CMAKE_CXX_LINKER_PREFERENCE)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
if (((NOT EXISTS ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/deps) OR ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/deps.tar.xz IS_NEWER_THAN ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/deps) AND CMAKE_BUILD_TYPE STREQUAL Debug)
    if (EXISTS ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/deps)
        file(RENAME ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/deps ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/dep)
    endif ()
    file(REMOVE_RECURSE ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/dep)
    message("Unpacking dependencies tarball...")
    file(ARCHIVE_EXTRACT INPUT ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/deps.tar.xz DESTINATION ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/dep)
    file(RENAME ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/dep/deps ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/deps)
    file(REMOVE_RECURSE ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/dep)
    file(TOUCH_NOCREATE ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/deps)
elseif (CMAKE_BUILD_TYPE STREQUAL Release)
    while (NOT EXISTS ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/deps)
    endwhile ()
    message("Found unpacked dependencies")
endif ()
file(COPY ${ILLUMINATION_ENGINE_BASE_DIRECTORY}/res DESTINATION ${CMAKE_BINARY_DIR}/bin)
if (UNIX)
    set(BUILD_SHARED_LIBS ON CACHE BOOL "" FORCE)
else ()
    set(BUILD_SHARED_LIBS OFF CACHE BOOL "" FORCE)
endif ()

if (CMAKE_BUILD_TYPE STREQUAL Debug)
    add_compile_options("-g")
else ()
    add_compile_options("-O3")
endif ()

add_subdirectory(src)